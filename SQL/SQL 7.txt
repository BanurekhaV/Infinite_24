--triggers
 --eg 1
 create or alter trigger trgInsertEmp
 on tblemployee
 for insert
 as
 begin
 select * from tblemployee
  select * from inserted  -- to understand that insertion is first happening in the inserted table  end
end
  --now when we insert into tblemployee the above trigger fires

  insert into tblEmployee values(118,'Yuvraj','Male',6750,3,190807,'Hyderabad')


create trigger trgUpdateEmp
on tblemployee
for update 
as
begin
select * from deleted
select * from inserted
end

select * from tblemployee

update tblEmployee set gender='Male' where EmpId=114

--let us create an audit table to track the events

create table EmployeeAudit(Message varchar(max))

create or alter trigger trgAuditInsert
on tblemployee for insert
as
begin
declare @id int
select @id=empid from inserted

insert into EmployeeAudit
values('New Employee with ID ' + ' '+cast(@id as varchar(5))+ ' is added at '
+cast(getdate()as nvarchar(15)))
end

--
insert into tblemployee values(120,'Sanjeev','Male',6900,1,7665544,'Chennai')

select * from employeeAudit

--create a delete trigger on tblemployee, which adds a row of 
--the deleted record in the audit table
create table EmployeeAudit(Message varchar(max))

create or alter trigger trgAuditDelete
on tblemployee for delete
as
begin
declare @id int
declare @ename varchar(25)
select @id=empid from deleted
select @ename=empname from deleted

insert into EmployeeAudit
values('Employee with ID ' + ' '+cast(@id as varchar(5))+ ' named '+ ' '+@ename+
' is deleted at '
+cast(getdate()as nvarchar(15)))
end

delete from tblEmployee where empid=200

--let us add a column to employeeaudit table
alter table employeeaudit
add AuditDate date

create or alter trigger trg_update_emp
on tblemployee
for update
as
begin
 --declare variables to hold old data
 declare @id int
 declare @oldname varchar(25),@newname varchar(100)
 declare @oldsalary float,@newsalary float
 declare @olddeptid int, @newdeptid int

 --declare a variable to build the audit string
 declare @auditdata varchar(max)
 --store the newly updated data into a temp table ('#') or use inserted table
 select * into #updatedtempdata from inserted

 --loop thru all the updated records incase we have updated many rows
 while(exists(select EmpId from #updatedtempdata))
  begin
   set @auditdata=' '

   --select the first row of tempdata when many rows were updated
   select top 1 @Id=empid, @newname=empname,
   @newsalary=salary,@newdeptid=deptid from #updatedtempdata

   --select the deleted data
   select @oldname=empname,
   @oldsalary=salary,
   @olddeptid=deptid from deleted where empid=@id

   set @auditdata='Employee with Id = '+cast(@id as varchar(5)) + ' changed' 
   --if old name and new name are not same then the data is updated
   if(@oldname <> @newname)
    begin
	 set @auditdata=@auditdata + ' Name from '+ @oldname + ' to '+@newname
	 end
--salary changes are recorded
 if(@oldsalary <> @newsalary)
  begin
   set @auditdata=@auditdata + ' Salary from '+ cast(@oldsalary as varchar(10)) +
   ' to ' +cast(@newsalary as varchar(10))
   end

   --dept changes are updated 
   if(@olddeptid <> @newdeptid)
   begin
    set @auditdata=@auditdata + ' Department from ' + cast(@olddeptid as varchar(5)) +
	 ' to ' +cast(@newdeptid as varchar(5))
	 end

	 -- the entire auditdata will now be added to employeeaudit table
	 insert into employeeaudit(Message,Auditdate) values(@auditdata,getdate())

	 --we need to delete the first row afterrecording changes
	 --so that the second row can be top 1
	 delete from #updatedtempdata where empid=@id

	 end
	end

	select * from tblemployee

	update tblemployee set empname='Sahana',gender='Female'
	where empid=111

	select * from employeeaudit